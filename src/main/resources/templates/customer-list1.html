<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="VoucherList.css">
    <link rel="stylesheet" href="create-voucher.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body>
<div class="container-fluid row p-0 m-0" style="height: 100vh;">
    <div class="col-lg-3 VoucherListLeft">
        <div class="BBLlogoContainer">
            <img src="images/login/BBL.png" alt="">
        </div>
        <div class="voucherListButtons">
            <ul class="nav nav-tabs tabContainer1" id="myTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <a href="/voucherlist">
                        <button class="nav-link custom-tab active" id="tab1-tab" data-bs-toggle="tab" data-bs-target="#tab1" type="button" role="tab" aria-controls="tab1" aria-selected="true">
                            <div class="tab-content-center">
                                <img src="/images/VoucherList/VOUCHERMAIN.png" alt="" class="tab-icon">
                                <span class="tab-text">Voucher</span>
                            </div>
                        </button>
                    </a>
                </li>
                <li class="nav-item" role="presentation">
                    <a href="/voucherlist">
                        <button class="nav-link custom-tab" id="tab2-tab" data-bs-toggle="tab" data-bs-target="#tab2" type="button" role="tab" aria-controls="tab2" aria-selected="false">
                            <div class="tab-content-center">
                                <img src="/images/VoucherList/PackagesIcon.png" alt="" class="tab-icon">
                                <span class="tab-text">Packages</span>
                            </div>
                        </button>
                    </a>
                </li>
                <li class="nav-item" role="presentation">
                    <a href="/voucherlist">
                        <button class="nav-link custom-tab" id="tab3-tab" data-bs-toggle="tab" data-bs-target="#tab3" type="button" role="tab" aria-controls="tab3" aria-selected="false">
                            <div class="tab-content-center">
                                <img src="/images/VoucherList/FootfallIcon.png" alt="" class="tab-icon">
                                <span class="tab-text">Footfall</span>
                            </div>
                        </button>
                    </a>
                </li>
                <li class="nav-item" role="presentation">
                    <a href="/voucherlist">
                        <button class="nav-link custom-tab" id="tab4-tab" data-bs-toggle="tab" data-bs-target="#tab4" type="button" role="tab" aria-controls="tab4" aria-selected="false">
                            <div class="tab-content-center">
                                <img src="/images/VoucherList/Partner.png" alt="" class="tab-icon">
                                <span class="tab-text">Partner</span>
                            </div>
                        </button>
                    </a>
                </li>
            </ul>
        </div>
        <form th:action="@{/logout}" method="post">



            <button class="logoutBtn" >

                <img src="/images/VoucherList/LogoutIcon.png" alt="" class="tab-icon" type="submit">
                <span class="tab-text">LogOut</span>

            </button>
        </form>
    </div>
    <div class="col-lg-9 p-0">
        <div class="container-fluid p-0 m-0">
            <div class="voucherListHeader container-fluid">
                <img src="images/VoucherList/PackagesIcon.png" alt="">
                <p>Customer List</p>
            </div>
        </div>
        <div class="container-fluid voucherListParent">
            <div class="voucherListDiv">
                <div class="voucherListoptions p-2">
                    <div class="voucherHeading" style="width: 30%;">
                        <img src="images/VoucherList/Packagelist.png" alt="">
                        <p>Customer List</p>
                    </div>
                    <div class="voucherListoptionsBox1" style="width:42%">
                        <div class="search-container">
                            <!-- Search input -->
                            <input type="text" placeholder="Search" id="partnerSearch" class="search-input">
                            <!-- Search icon -->
                            <i class="bi bi-search search-icon"></i>
                        </div>
                        <div class="clientListDiv">
                            <a href="/clientlist">Walkin Customer List </a>
                        </div>
                        <div class="importDiv" onclick="exportTableToExcel('ticketTable', 'customer_list.xlsx')">
                            <img src="/images/VoucherList/EXPORT.png" alt="">
                        </div>
                    </div>
                </div>
                <div id="tableContainer">
                    <table id="ticketTable">
                        <thead>
                        <tr>
                            <th id="sort-customerName">Customer Name <img src="images/VoucherList/SORT.png" alt="" style="height: 18px;"></th>
                            <th id="sort-date">Date <img src="images/VoucherList/SORT.png" alt="" style="height: 18px;"></th>
                            <th id="sort-paymentMode">Payment Mode <img src="images/VoucherList/SORT.png" alt="" style="height: 18px;"></th>
                            <th id="sort-typeOfCustomer">Type of Customer <img src="images/VoucherList/SORT.png" alt="" style="height: 18px;"></th>
                            <th id="sort-flightNumber">Flight Number <img src="images/VoucherList/SORT.png" alt="" style="height: 18px;"></th>
                            <th id="sort-createdby">createdBy <img src="#" alt="" style="height: 18px;"></th>
                        </tr>
                        </thead>
                        <tbody id="ticketTableBody">
                        <!-- Data will be populated here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var jsonData = [];
    var currentSortColumn = '';
    var currentSortDirection = true; // true for ascending, false for descending

    function exportTableToExcel(tableId, filename = 'exported_data.xlsx') {
        var table = document.getElementById(tableId);
        var worksheet = XLSX.utils.table_to_sheet(table);
        var workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");
        XLSX.writeFile(workbook, filename);
    }

    function formatDateString(inputDateString) {
        const date = new Date(inputDateString);
        const year = date.getUTCFullYear();
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const day = String(date.getUTCDate()).padStart(2, '0');
        const hours = String(date.getUTCHours()).padStart(2, '0');
        const minutes = String(date.getUTCMinutes()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    async function populateTable() {
        const response = await fetch('/api/ticket/getAllTicket');
        const data = await response.json();
        jsonData = data;
        displayTickets(jsonData);
    }

    function displayTickets(tickets) {
        const tableBody = document.getElementById('ticketTableBody');
        tableBody.innerHTML = '';
        tickets.forEach(ticket => {
            const row = document.createElement('tr');
            const customerName = `${ticket.firstName} ${ticket.lastName}`;
            const formattedDate = formatDateString(ticket.date);
            row.innerHTML = `
                <td><a href="/customer/details/${ticket.ticketId}">${ticket.firstName}</a></td>
                <td>${formattedDate}</td>
                <td>${ticket.paymentMethod}</td>
                <td>${ticket.ticketType}</td>
                <td>${ticket.flightNumber}</td>
                <td>${ticket.createdBy}</td>
            `;
            tableBody.appendChild(row);
        });
    }

    function filterTickets() {
        const query = document.getElementById('partnerSearch').value.toLowerCase();
        const filteredTickets = jsonData.filter(ticket => {
            const customerName = `${ticket.firstName} ${ticket.lastName}`.toLowerCase();
            const flightNumber = ticket.flightNumber.toLowerCase();
            return customerName.includes(query) || flightNumber.includes(query);
        });
        displayTickets(filteredTickets);
    }

    function sortTable(column) {
        if (currentSortColumn === column) {
            currentSortDirection = !currentSortDirection;
        } else {
            currentSortColumn = column;
            currentSortDirection = true;
        }

        jsonData.sort((a, b) => {
            let valA, valB;

            if (column === 'customerName') {
                valA = `${a.firstName || ''} ${a.lastName || ''}`.toUpperCase();
                valB = `${b.firstName || ''} ${b.lastName || ''}`.toUpperCase();
            } else if (column === 'date') {
                valA = new Date(a.date);
                valB = new Date(b.date);
            } else {
                valA = a[column] ? a[column].toString().toUpperCase() : '';
                valB = b[column] ? b[column].toString().toUpperCase() : '';
            }

            if (valA < valB) return currentSortDirection ? -1 : 1;
            if (valA > valB) return currentSortDirection ? 1 : -1;
            return 0;
        });

        displayTickets(jsonData);
    }

    window.onload = () => {
        populateTable();
        document.getElementById('partnerSearch').addEventListener('input', filterTickets);
        document.getElementById('sort-customerName').addEventListener('click', () => sortTable('customerName'));
        document.getElementById('sort-date').addEventListener('click', () => sortTable('date'));
        document.getElementById('sort-paymentMode').addEventListener('click', () => sortTable('paymentMethod'));
        document.getElementById('sort-typeOfCustomer').addEventListener('click', () => sortTable('ticketType'));
        document.getElementById('sort-flightNumber').addEventListener('click', () => sortTable('flightNumber'));
        document.getElementById('sort-createdby').addEventListener('click', () => sortTable('createdby'));
    };
</script>

</body>
</html>
