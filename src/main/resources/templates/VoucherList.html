<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="VoucherList.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Bootstrap JS (Include this at the end of your body tag) -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>


</head>
<body>
<input type="hidden" name="_csrf" th:value="${_csrf.token}">
<input id="username" type="hidden" name="_csrf" th:value="${username}">
<div class="container-fluid row p-0 m-0" style="height: 100vh;">

    <div class="col-lg-3 VoucherListLeft">

        <div class="BBLlogoContainer">
            <img src="images/login/BBL.png" alt="">
        </div>

        <div class="voucherListButtons">
            <ul class="nav nav-tabs tabContainer1" id="myTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link custom-tab active" id="tab1-tab" data-bs-toggle="tab" data-bs-target="#tab1" type="button" role="tab" aria-controls="tab1" aria-selected="true">
                        <div class="tab-content-center">
                            <img src="/images/VoucherList/VOUCHERMAIN.png" alt="" class="tab-icon">
                            <span class="tab-text">Voucher</span>
                        </div>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link custom-tab" id="tab2-tab" data-bs-toggle="tab" data-bs-target="#tab2" type="button" role="tab" aria-controls="tab2" aria-selected="false">
                        <div class="tab-content-center">
                            <img src="/images/VoucherList/PackagesIcon.png" alt="" class="tab-icon">
                            <span class="tab-text">Packages</span>
                        </div>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link custom-tab" id="tab3-tab" data-bs-toggle="tab" data-bs-target="#tab3" type="button" role="tab" aria-controls="tab3" aria-selected="false">
                        <div class="tab-content-center">
                            <img src="/images/VoucherList/FootfallIcon.png" alt="" class="tab-icon">
                            <span class="tab-text">Footfall</span>
                        </div>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link custom-tab" id="tab4-tab" data-bs-toggle="tab" data-bs-target="#tab4" type="button" role="tab" aria-controls="tab4" aria-selected="false">
                        <div class="tab-content-center">
                            <img src="/images/VoucherList/Partner.png" alt="" class="tab-icon">
                            <span class="tab-text">Partner</span>
                        </div>
                    </button>
                </li>
            </ul>
        </div>

        <form th:action="@{/logout}" method="post">
            <button class="logoutBtn">
                <img src="/images/VoucherList/LogoutIcon.png" alt="" class="tab-icon" type="submit">
                <span class="tab-text">LogOut</span>
            </button>
        </form>

    </div>

    <div class="col-lg-9 p-0">

        <div class="tab-content" id="myTabsContent">
            <div class="tab-pane fade show active" id="tab1" role="tabpanel" aria-labelledby="tab1-tab">
                <div class="container-fluid p-0 m-0">
                    <div class="voucherListHeader container-fluid">
                        <img src="images/VoucherList/VOUCHERMAIN.png" alt="">
                        <p>Voucher List</p>
                    </div>
                </div>
                <div class="container-fluid voucherListParent">
                    <div class="voucherListDiv">
                        <div class="voucherListoptions p-2">
                            <div class="voucherHeading">
                                <img src="images/VoucherList/ICONV.png" alt="">
                                <p>Voucher List</p>
                            </div>
                            <div class="voucherListoptionsBox" style="width:51%">
                                <div class="search-container">
                                    <!-- Search input -->
                                    <input type="text" placeholder="Search" class="search-input">
                                    <!-- Search icon -->
                                    <i class="bi bi-search search-icon"></i>
                                </div>

                                <div class="clientListDiv">
                                    <a href="/client"> View Client List </a>
                                </div>

                                <a href="/qrid" class="importDiv">
                                    <img src="/images/VoucherList/downloadicon.png" alt="">

                                </a>
                                <div class="importDiv" onclick="exportTableToExcel('voucherTableContainer', 'voucher_list.xlsx')">
                                    <img src="/images/VoucherList/EXPORT.png" alt="">
                                </div>
                                <div class="importDiv">
                                    <img src="/images/VoucherList/FILTER.png" alt="" data-bs-toggle="modal" data-bs-target="#filterModal" style="cursor: pointer;height: 12px">
                                </div>

                                <div class="modal" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h3 class="modal-title mx-4" id="filterModalLabel">Filter</h3>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="bg-white dark:bg-zinc-700 p-4 rounded-lg shadow-md max-w-sm">
                                                    <div class="mb-4">
                                                        <h5 class="filteroptionsheading">Voucher Name</h5>
                                                        <div class="packageListoptions">
                                                            <label class="flex items-center">
                                                                <input type="checkbox" class="form-checkbox h-4 w-4" id="voucherStandardAirtel" />
                                                                <span class="ml-2">Standard Airtel</span>
                                                            </label>
                                                            <label class="flex items-center">
                                                                <input type="checkbox" class="form-checkbox h-4 w-4" id="voucherPremiumAirtel" />
                                                                <span class="ml-2">Premium Airtel</span>
                                                            </label>
                                                            <label class="flex items-center">
                                                                <input type="checkbox" class="form-checkbox h-4 w-4" id="voucherPremiumBBT" />
                                                                <span class="ml-2">Premium BBT</span>
                                                            </label>
                                                            <label class="flex items-center">
                                                                <input type="checkbox" class="form-checkbox h-4 w-4" id="voucherPremiumNH" />
                                                                <span class="ml-2">Premium Next Holidays</span>
                                                            </label>
                                                        </div>
                                                    </div>

                                                    <div class="mb-4">
                                                        <h5 class="filteroptionsheading">Package Name</h5>
                                                        <div class="packageListoptions">
                                                            <label class="flex items-center">
                                                                <input type="checkbox" class="form-checkbox h-4 w-4" id="packageStandard" />
                                                                <span class="ml-2">Standard</span>
                                                            </label>
                                                            <label class="flex items-center">
                                                                <input type="checkbox" class="form-checkbox h-4 w-4" id="packagePremium" />
                                                                <span class="ml-2">Premium</span>
                                                            </label>
                                                            <label class="flex items-center">
                                                                <input type="checkbox" class="form-checkbox h-4 w-4" id="packagePremiumPlus" />
                                                                <span class="ml-2">Premium Plus</span>
                                                            </label>
                                                            <label class="flex items-center">
                                                                <input type="checkbox" class="form-checkbox h-4 w-4" id="packagePlatinum" />
                                                                <span class="ml-2">Platinum</span>
                                                            </label>
                                                        </div>
                                                    </div>

                                                    <div class="mb-4">
                                                        <h5 class="filteroptionsheading">Voucher Issued</h5>
                                                        <div class="flex justify-between">
                                                            <input type="date" class="form-input filterdatesInput" id="issuedFrom" />
                                                            to
                                                            <input type="date" class="form-input filterdatesInput" id="issuedTo" />
                                                        </div>
                                                    </div>

                                                    <div class="mb-4">
                                                        <h5 class="filteroptionsheading">Voucher Expired</h5>
                                                        <div class="flex justify-between">
                                                            <input type="date" class="form-input filterdatesInput" id="expiredFrom" />
                                                            to
                                                            <input type="date" class="form-input filterdatesInput" id="expiredTo" />
                                                        </div>
                                                    </div>

                                                    <button class="filterselectBtn" onclick="applyFilters()">
                                                        APPLY
                                                    </button>
                                                    <button class="filterremoveBtn" onclick="removeFilters()">
                                                        REMOVE FILTER
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="addDiv">
                                    <a href="/create-voucher">
                                        <img src="/images/VoucherList/add.png" alt="">
                                    </a>
                                </div>
                            </div>

                        </div>
                        <div id="voucherTableContainer">
                            <table>
                                <thead>
                                <tr>
                                    <th>Voucher ID</th>
                                    <th id="sort-voucherName">Voucher Name <img src="images/VoucherList/SORT.png" alt="" style="height: 14px;"></th>
                                    <th id="sort-clientName">Client Name <img src="images/VoucherList/SORT.png" alt="" style="height: 14px;"></th>
                                    <th id="sort-noOfVouchers">No. Of Vouchers <img src="images/VoucherList/SORT.png" alt="" style="height: 14px;"></th>
                                    <th id="sort-vouchersClaimed">Vouchers Claimed <img src="images/VoucherList/SORT.png" alt="" style="height: 14px;"></th>
                                    <th id="sort-packageName">Package Name <img src="images/VoucherList/SORT.png" alt="" style="height: 14px;"></th>
                                    <th id="sort-voucherExpired">Voucher Expired <img src="images/VoucherList/SORT.png" alt="" style="height: 14px;"></th>
                                    <th id="sort-voucherIssued">Voucher Issued <img src="images/VoucherList/SORT.png" alt="" style="height: 14px;"></th>
                                    <th id="sort-preparedBy">Created By </th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="voucherListBody">
                                <!-- Dynamic content will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>


            <div class="tab-pane fade" id="tab2" role="tabpanel" aria-labelledby="tab2-tab">

                <div class="container-fluid p-0 m-0">
                    <div class="voucherListHeader container-fluid">
                        <img src="images/VoucherList/PackagesIcon.png" alt="">
                        <p>Package List</p>
                    </div>
                </div>
                <div class="container-fluid voucherListParent">
                    <div class="voucherListDiv">
                        <div class="voucherListoptions p-2">
                            <div class="voucherHeading">
                                <img src="images/VoucherList/Packagelist.png" alt="">
                                <p>Package List</p>
                            </div>
                            <div class="voucherListoptionsBox1" style="width:29%">
                                <div class="search-container">
                                    <!-- Search input -->
                                    <input type="text" placeholder="Search" class="search-input">
                                    <!-- Search icon -->
                                    <i class="bi bi-search search-icon"></i>
                                </div>

                                <div class="importDiv" onclick="exportTableToExcel('packageContainer', 'package_list.xlsx')">
                                    <img src="/images/VoucherList/EXPORT.png" alt="">
                                </div>

                                <div class="addDiv">
                                    <a href="/create-package">
                                        <img src="/images/VoucherList/add.png" alt="">
                                    </a>
                                </div>
                            </div>

                        </div>
                        <div>
                            <table id="packageContainer">
                                <thead>
                                <tr>
                                    <th>Package ID </th>
                                    <th>Package Name </th> <!-- changed ID to sort-packageName2 to avoid conflict -->
                                    <th>Hour Access </th>
                                    <th>Wifi </th>
                                    <th>Drinks </th>
                                    <th>Meal </th>
                                    <th>Status </th>
                                </tr>
                                </thead>
                                <tbody id="packageTableBody">
                                <!-- Dynamic content will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>


            <div class="tab-pane fade" id="tab3" role="tabpanel" aria-labelledby="tab3-tab">

                <div class="container-fluid p-0 m-0">
                    <div class="voucherListHeader container-fluid">
                        <img src="images/VoucherList/FootfallIcon.png" alt="">
                        <p>Footfall</p>
                    </div>
                </div>
                <div class="container-fluid voucherListParent" style="padding-bottom: 2% !important;">
                    <!--<div class="packageCheckBoxContainers">
                        <h6 class="my-1">Day</h6>
                        <label class="switch">
                            <input type="checkbox" checked>
                            <span class="toggleBtn round"></span>
                        </label>
                        <h6 class="my-1">Month</h6>
                    </div>-->
                    <div class="footfallBoxContainers mt-4">
                        <a href="customer-list">
                            <div>
                                <img src="/images/VoucherList/Totalperson.png" alt="">
                                <h2 id="totalTickets" class="mt-3 fw-bold fs-1"></h2>
                                <p class="text-muted">Total Person Visited</p>
                            </div>
                        </a>
                        <a href="customer-list">
                            <div>
                                <img src="/images/VoucherList/VoucheUtilized.png" alt="">
                                <h2 id="voucherTickets" class="mt-3 fw-bold fs-1"></h2>
                                <p class="text-muted">Voucher Utilized</p>
                            </div>
                        </a>
                        <a href="customer-list">
                            <div>
                                <img src="/images/VoucherList/Partnemember.png" alt="">
                                <h2 id="partnerTickets" class="mt-3 fw-bold fs-1"></h2>
                                <p class="text-muted">Partner Member Visit</p>
                            </div>
                        </a>
                        <a href="customer-list">
                            <div>
                                <img src="/images/VoucherList/Airlinesbox.png" alt="">
                                <h2 id="airlineTickets" class="mt-3 fw-bold fs-1"></h2>
                                <p class="text-muted">Airline Member Visit</p>
                            </div>
                        </a>
                    </div>

                    <div class="mt-4 footfallDataDiv">
                        <div id="partnersContainer" class="footfallscrolldata"></div>
                        <div class="footfallCustomerOption" style="width:50%">
                            <div class="search-container">
                                <!-- Search input -->
                                <input type="text" placeholder="Search" class="footfallSearch" id="searchInput">
                                <!-- Search icon -->
                                <i class="bi bi-search search-icon" style="right:32px"></i>
                            </div>
                            <select name="" id="statusSelect" class="footfallSelect">
                                <option value="">Payment Type</option>
                                <option value="Cash">Cash</option>
                                <option value="Credit">Credit</option>

                            </select>
                            <div class="footfallDates">
                                <input type="date" id="startDate">
                                <input type="date" id="endDate">
                            </div>
                            <div class="footfallSearchBtn">
                                <button id="Reset">Reset</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="tab-pane fade" id="tab4" role="tabpanel" aria-labelledby="tab4-tab">
                <div class="container-fluid p-0 m-0">
                    <div class="voucherListHeader container-fluid">
                        <img src="images/VoucherList/Partner.png" alt="">
                        <p>Partner List</p>
                    </div>
                </div>
                <div class="container-fluid voucherListParent">
                    <div class="voucherListDiv">
                        <div class="voucherListoptions p-2">
                            <div class="voucherHeading">
                                <img src="images/VoucherList/Partner.png" alt="">
                                <p>Partner List</p>
                            </div>
                            <div class="voucherListoptionsBox" style="width: 29%;">
                                <div class="search-container">
                                    <!-- Search input -->
                                    <input type="text" placeholder="Search" id="partnerSearch" class="search-input">
                                    <!-- Search icon -->
                                    <i class="bi bi-search search-icon"></i>
                                </div>
                                <div class="importDiv" onclick="exportTableToExcel('partnerTable', 'partner_list.xlsx')">
                                    <img src="/images/VoucherList/EXPORT.png" alt="">
                                </div>
                                <div class="addDiv">
                                    <a href="/create-partner">
                                        <img src="/images/VoucherList/add.png" alt="">
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div id="partnerList">
                            <table id="partnerTable">
                                <thead>
                                <tr>
                                    <th id="sort-partnerType">Partner Type <img src="images/VoucherList/SORT.png" alt="" style="height: 18px;"></th>
                                    <th id="sort-partnerName">Partner Name <img src="images/VoucherList/SORT.png" alt="" style="height: 18px;"></th>
                                    <th id="sort-confirmationMode">Confirmation Mode <img src="images/VoucherList/SORT.png" alt="" style="height: 18px;"></th>
                                    <th id="sort-confirmationFormat">Confirmation Format <img src="images/VoucherList/SORT.png" alt="" style="height: 18px;"></th>
                                    <th id="sort-packageName">Type of Package Name <img src="images/VoucherList/SORT.png" alt="" style="height: 18px;"></th>
                                    <th id="sort-discount">Discount <img src="images/VoucherList/SORT.png" alt="" style="height: 18px;"></th>

                                    <th id="sort-createdBy">Created By Name / Email <img src="images/VoucherList/SORT.png" alt="" style="height: 18px;"></th>
                                </tr>
                                </thead>
                                <tbody id="partnerTableBody">
                                <!-- Data will be populated dynamically here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>



        </div>


    </div>

</div>
<!-- Voucher Details Modal -->
<div class="modal fade" id="voucherDetailsModal" tabindex="-1" aria-labelledby="voucherDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="voucherDetailsModalLabel">Voucher Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Voucher ID:</strong> <span id="modalVoucherId"></span></p>
                <p><strong>Voucher Name:</strong> <span id="modalVoucherName"></span></p>
                <p><strong>Client Name:</strong> <span id="modalClientName"></span></p>
                <p><strong>No. Of Vouchers:</strong> <span id="modalNoOfVouchers"></span></p>
                <p><strong>Vouchers Claimed:</strong> <span id="modalVouchersClaimed"></span></p>
                <p><strong>Package Name:</strong> <span id="modalPackageName"></span></p>
                <p><strong>Voucher Expired:</strong> <span id="modalVoucherExpired"></span></p>
                <p><strong>Voucher Issued:</strong> <span id="modalVoucherIssued"></span></p>
                <p><strong>Total Amount:</strong> <span id="modalTotalAmount"></span></p>
                <p><strong>Amount Paid:</strong> <span id="modalAmountPaid"></span></p>
                <p><strong>Amount Due:</strong> <span id="modalAmountDue"></span></p>
                <p><strong>Created By:</strong> <span id="modalPreparedBy"></span></p>
            </div>
        </div>
    </div>
</div>




<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>


<script>

    // Fetch partners data when the page loads



    document.addEventListener('DOMContentLoaded', () => {
        let vouchers = [];

        // Fetch vouchers data from API
        fetch('/api/voucher/getAll')
            .then(response => response.json())
            .then(data => {
                vouchers = data; // Populate vouchers array
                console.log('Vouchers fetched:', vouchers); // Debugging log
                fetchPackageNames(vouchers);
                footfallPartner(vouchers);
            })
            .catch(error => console.error('Error fetching vouchers:', error));

        const searchInput = document.getElementById('searchInput');
        const statusSelect = document.getElementById('statusSelect');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const searchBtn = document.getElementById('Reset');

        function filterVouchers() {
            const searchText = searchInput.value.toLowerCase();
            const status = statusSelect.value;
            const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
            const endDate = endDateInput.value ? new Date(endDateInput.value) : null;

            const filteredVouchers = vouchers.filter(voucher => {
                const voucherNameMatch = voucher.voucherName.toLowerCase().includes( searchText);
                const statusMatch =voucher.paymentType.includes(status);
                const validDate = new Date(voucher.validDate);
                const dateRangeMatch = (!startDate || validDate >= startDate) && (!endDate || validDate <= endDate);

                return voucherNameMatch && statusMatch && dateRangeMatch;
            });

            footfallPartner(filteredVouchers);
        }
        function resetform() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusSelect').selectedIndex = 0;
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';

            filterVouchers();
        };

        searchInput.addEventListener('input', filterVouchers);
        statusSelect.addEventListener('change', filterVouchers);
        startDateInput.addEventListener('change', filterVouchers);
        endDateInput.addEventListener('change', filterVouchers);
        searchBtn.addEventListener('click',resetform );


        function footfallPartner(vouchers) {
            const partnersContainer = document.getElementById('partnersContainer');
            partnersContainer.innerHTML = ''; // Clear existing content

            vouchers.forEach(voucher => {
                const partnerHtml = `
                <div class="footfallCustomerOptionContainer">
                    <div class="footfallCustomerOptionImg">
                        <div class="footfalloptionText">
                            <h5>${voucher.voucherName}</h5>
                        </div>
                        <div class="footfalldataDiv">
                            <div class="footfallNumber">
                                <div class="footfallNumberBox">
                                    <h2 style="font-size: 40px">${voucher.claimed}/ <span style="font-size: 20px;margin-left: -11px">${voucher.noOfVouchers}</span> </h2>
                                </div>
                                <p style="color: #B8B8B8;font-size: 14px;text-align: center">Voucher Enchased</p>
                            </div>
                            <div class="footfallList">
                                <ul>
                                    <li class="text-muted">${voucher.client.clientName}</li>
                                    <li class="text-muted">Expired by ${voucher.validDate}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
                partnersContainer.innerHTML += partnerHtml;
            });
        }
    });

    function exportTableToExcel(tableId, filename = 'exported_data.xlsx') {
        // Get the table element
        var table = document.getElementById(tableId);

        // Convert the table to a worksheet
        var worksheet = XLSX.utils.table_to_sheet(table);

        // Create a new workbook and append the worksheet
        var workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");

        // Export the workbook to a file
        XLSX.writeFile(workbook, filename);
    }


    let packages = [];

    let vouchers = [];

    fetch('/api/voucher/getAll')
        .then(response => response.json())
        .then(data => {
            vouchers = data; // Populate vouchers array
            console.log('Vouchers fetched:', vouchers); // Debugging log
            fetchPackageNames(vouchers);

        })
        .catch(error => console.error('Error fetching vouchers:', error));

    function fetchPackageNames(vouchers) {
        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        console.log(csrfToken);
        console.log(csrfHeader);
        // Ensure CSRF token and header name are retrieved correctly
        if (!csrfToken || !csrfHeader) {
            console.error('CSRF token or header name not found');
            alert('CSRF token or header name not found. Please check your HTML.');
            return;
        }

        // Create headers object
        const headers = new Headers();
        headers.append('Content-Type', 'application/json');
        headers.append(csrfHeader, csrfToken);
        Promise.all(vouchers.map(voucher => {
            return fetch('/api/packages/details/' + voucher.packageDetails.packageId)
                .then(response => response.json())
                .then(packageData => {
                    voucher.packageName = packageData.packageName;
                    return voucher;
                });
        })).then(vouchersWithPackageNames => {
            displayVouchers(vouchersWithPackageNames);
        });
    }

    function displayVouchers(vouchers) {
        const voucherListBody = document.getElementById('voucherListBody');

        if (vouchers.length === 0) {
            voucherListBody.innerHTML = '<tr><td colspan="9">No vouchers found.</td></tr>';
        } else {
            voucherListBody.innerHTML = '';
            vouchers.forEach(voucher => {
                const row = document.createElement('tr');

                const voucherIdCell = document.createElement('td');
                voucherIdCell.textContent = voucher.voucherId;
                voucherIdCell.style.paddingLeft = '28px';  // Add padding
                voucherIdCell.style.cursor = 'pointer';  // Add cursor style
                voucherIdCell.addEventListener('click', () => {
                    showVoucherDetails(voucher);
                });
                row.appendChild(voucherIdCell);

                const voucherNameCell = document.createElement('td');
                voucherNameCell.textContent = voucher.voucherName;
                row.appendChild(voucherNameCell);

                const clientNameCell = document.createElement('td');
                clientNameCell.textContent = voucher.client ? voucher.client.clientName : 'N/A';
                row.appendChild(clientNameCell);

                const noOfVouchersCell = document.createElement('td');
                noOfVouchersCell.textContent = voucher.noOfVouchers;
                noOfVouchersCell.style.paddingLeft = '28px';  // Add padding
                noOfVouchersCell.style.cursor = 'pointer';  // Add cursor style
                noOfVouchersCell.addEventListener('click', () => {
                    window.location.href = `/qrid2/${voucher.voucherId}`;
                });
                row.appendChild(noOfVouchersCell);


                const vouchersClaimedCell = document.createElement('td');
                vouchersClaimedCell.textContent = voucher.claimed;
                vouchersClaimedCell.style.paddingLeft = '28px';  // Add padding
                vouchersClaimedCell.style.cursor = 'pointer';  // Add cursor style
                vouchersClaimedCell.addEventListener('click', () => {
                    window.location.href = `/qrid2/${voucher.voucherId}`;
                });
                row.appendChild(vouchersClaimedCell);

                const packageNameCell = document.createElement('td');
                packageNameCell.textContent = voucher.packageName;
                row.appendChild(packageNameCell);

                const voucherExpiredCell = document.createElement('td');
                voucherExpiredCell.textContent = voucher.validDate;
                row.appendChild(voucherExpiredCell);

                const voucherIssuedCell = document.createElement('td');
                voucherIssuedCell.textContent = voucher.issueDate;
                row.appendChild(voucherIssuedCell);

                const voucherPreparedCell = document.createElement('td');
                voucherPreparedCell.textContent = voucher.preparedBy;
                row.appendChild(voucherPreparedCell);

                var actionsCell = document.createElement('td');
                var editIcon = document.createElement('img');
                editIcon.src = 'images/VoucherList/EDIT.png';
                editIcon.alt = 'Edit';
                editIcon.style.height = '15px';
                editIcon.style.marginLeft = '0px';
                editIcon.addEventListener('click', () => {
                    window.location.href = `/updateVoucher/${voucher.voucherId}`;
                });
                row.appendChild(editIcon);

                voucherListBody.appendChild(row);
            });
        }
    }
    function showVoucherDetails(voucher) {
        document.getElementById('modalVoucherId').textContent = voucher.voucherId;
        document.getElementById('modalVoucherName').textContent = voucher.voucherName;
        document.getElementById('modalClientName').textContent = voucher.client ? voucher.client.clientName : 'N/A';
        document.getElementById('modalNoOfVouchers').textContent = voucher.noOfVouchers;
        document.getElementById('modalVouchersClaimed').textContent = voucher.claimed;
        document.getElementById('modalPackageName').textContent = voucher.packageName;
        document.getElementById('modalVoucherExpired').textContent = voucher.validDate;
        document.getElementById('modalVoucherIssued').textContent = voucher.issueDate;
        document.getElementById('modalTotalAmount').textContent = voucher.amount;
        document.getElementById('modalAmountPaid').textContent = voucher.cashPaid;
        document.getElementById('modalAmountDue').textContent = voucher.dueAmount;

        document.getElementById('modalPreparedBy').textContent = voucher.preparedBy;

        // Show the modal
        const voucherDetailsModal = new bootstrap.Modal(document.getElementById('voucherDetailsModal'));
        voucherDetailsModal.show();
    }



    // Search functionality
    document.querySelector('.search-input').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const filteredVouchers = vouchers.filter(voucher => {
            return (
                voucher.voucherName.toLowerCase().includes(searchTerm) ||
                (voucher.client && voucher.client.clientName.toLowerCase().includes(searchTerm)) ||
                voucher.packageName.toLowerCase().includes(searchTerm)
            );
        });
        displayVouchers(filteredVouchers);
    });

    function deleteVoucher(voucherId) {
        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        console.log(csrfToken);
        console.log(csrfHeader);
        // Ensure CSRF token and header name are retrieved correctly
        if (!csrfToken || !csrfHeader) {
            console.error('CSRF token or header name not found');
            alert('CSRF token or header name not found. Please check your HTML.');
            return;
        }

        // Create headers object
        const headers = new Headers();
        headers.append('Content-Type', 'application/json');
        headers.append(csrfHeader, csrfToken);
        if (confirm('Are you sure you want to delete this voucher?')) {
            fetch('/api/voucher/delete?voucherID=' + voucherId, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    location.reload();
                })
                .catch(error => console.error('Error deleting voucher:', error));
        }
    }

    function updateVoucher(voucherId) {
        window.location.href = '/voucher/update/update-voucher?id=' + voucherId;
    }

    $(document).ready(function() {
        let packages = [];

        // Function to fetch package details
        function fetchPackages() {
            $.get('/api/packages/getAllPackages', function(data) {
                packages = data; // Populate packages array
                displayPackages(packages); // Display all packages initially
            });
        }

        // Function to display packages
        function displayPackages(packages) {
            $('#packageTableBody').empty(); // Clear existing rows
            if (packages.length === 0) {
                $('#packageTableBody').append('<tr><td colspan="8">No packages found.</td></tr>');
            } else {
                packages.forEach(function(package) {
                    const row = `
                    <tr id="package-${package.packageId}">
                        <td style="padding-left: 25px">${package.packageId}</td>
                        <td>${package.packageName}</td>
                        <td>${package.hour}</td>
                        <td>${package.wifi ? 'Included' : 'Not Included'}</td>
                        <td>${package.drinks ? 'Included' : 'Not Included'}</td>
                        <td>${package.lunch ? 'Included' : 'Not Included'}</td>
                        <td>
                            <button id="package-${package.packageId}" onclick="statusPackage(${package.packageId})" class="${package.flag ? 'active1' : 'inactive1'}">
                                ${package.flag ? 'Active' : 'Inactive'}
                            </button>
                        </td>
                    </tr>
                `;
                    $('#packageTableBody').append(row); // Append new row
                });
            }
        }

        // Search functionality
        $('.search-input').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            const filteredPackages = packages.filter(pkg => {
                return (
                    pkg.packageName.toLowerCase().includes(searchTerm) ||
                    pkg.packageId.toString().includes(searchTerm)
                );
            });
            displayPackages(filteredPackages);
        });

        // Initial fetch and display of packages
        fetchPackages();
    });

    function statusPackage(packageId) {
        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        console.log('CSRF Token:', csrfToken);
        console.log('CSRF Header:', csrfHeader);

        // Ensure CSRF token and header name are retrieved correctly
        if (!csrfToken || !csrfHeader) {
            console.error('CSRF token or header name not found');
            alert('CSRF token or header name not found. Please check your HTML.');
            return;
        }

        // Create headers object
        const headers = new Headers();
        headers.append('Content-Type', 'application/json');
        headers.append(csrfHeader, csrfToken);

        // Debug: Log headers
        console.log('Headers:', headers);

        fetch(`/api/packages/updateFlag?packageId=${packageId}`, {
            method: 'PUT',
            headers: headers // Include headers in the request
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(updatedPackage => {
                const statusCell = document.querySelector(`#package-${packageId} button[onclick="statusPackage(${packageId})"]`);  // Access the entire cell
                statusCell.textContent = updatedPackage.flag ? 'Active' : 'Inactive';

                // Update background color based on updated flag
                statusCell.style.backgroundColor = updatedPackage.flag ? 'green' : 'red';
            })
            .catch(error => console.error('Error updating package status:', error));
    }


    function deletePackage (packageId) {
        $.ajax({
            url: '/api/packages/removePackage',
            type: 'DELETE',
            data: { packageId: packageId },
            success: function() {
                // Remove the deleted row from the table
                $('#package-' + packageId).remove();
            },
            error: function(xhr, status, error) {
                console.error('Failed to delete package:', error);
            }
        });
    };


    function applyFilters() {
        const voucherStandardAirtel = document.getElementById('voucherStandardAirtel').checked;
        const voucherPremiumAirtel = document.getElementById('voucherPremiumAirtel').checked;
        const voucherPremiumBBT = document.getElementById('voucherPremiumBBT').checked;
        const voucherPremiumNH = document.getElementById('voucherPremiumNH').checked;
        const packageStandard = document.getElementById('packageStandard').checked;
        const packagePremium = document.getElementById('packagePremium').checked;
        const packagePremiumPlus = document.getElementById('packagePremiumPlus').checked;
        const packagePlatinum = document.getElementById('packagePlatinum').checked;
        const issuedFrom = document.getElementById('issuedFrom').value;
        const issuedTo = document.getElementById('issuedTo').value;
        const expiredFrom = document.getElementById('expiredFrom').value;
        const expiredTo = document.getElementById('expiredTo').value;

        const filteredVouchers = vouchers.filter(voucher => {
            let matchesVoucherName = (
                (!voucherStandardAirtel || voucher.voucherName === 'Standard Airtel') &&
                (!voucherPremiumAirtel || voucher.voucherName === 'Premium Airtel') &&
                (!voucherPremiumBBT || voucher.voucherName === 'Premium BBT') &&
                (!voucherPremiumNH || voucher.voucherName === 'Premium Next Holidays')
            );

            let matchesPackageName = (
                (!packageStandard || voucher.packageName === 'Standard') &&
                (!packagePremium || voucher.packageName === 'Premium') &&
                (!packagePremiumPlus || voucher.packageName === 'Premium Plus') &&
                (!packagePlatinum || voucher.packageName === 'Platinum')
            );

            let matchesIssuedDate = (
                (!issuedFrom || new Date(voucher.issueDate) >= new Date(issuedFrom)) &&
                (!issuedTo || new Date(voucher.issueDate) <= new Date(issuedTo))
            );

            let matchesExpiredDate = (
                (!expiredFrom || new Date(voucher.validDate) >= new Date(expiredFrom)) &&
                (!expiredTo || new Date(voucher.validDate) <= new Date(expiredTo))
            );

            return matchesVoucherName && matchesPackageName && matchesIssuedDate && matchesExpiredDate;
        });

        console.log('Filtered Vouchers:', filteredVouchers); // Debugging log
        displayVouchers(filteredVouchers);

        // Properly hide the modal
        const filterModal = bootstrap.Modal.getInstance(document.getElementById('filterModal'));
        filterModal.hide();

        // Manually remove the backdrop if necessary
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
            backdrop.remove();
        });
    }

    function removeFilters() {
        displayVouchers(vouchers);
        const filterModal = bootstrap.Modal.getInstance(document.getElementById('filterModal'));
        filterModal.hide();
    }


    function sortVouchers(column, ascending = true) {
        vouchers.sort((a, b) => {
            let valA = a[column];
            let valB = b[column];

            if (typeof valA === 'string') {
                valA = valA.toUpperCase();
                valB = valB.toUpperCase();
            }

            if (valA < valB) return ascending ? -1 : 1;
            if (valA > valB) return ascending ? 1 : -1;
            return 0;
        });
        displayVouchers(vouchers);
    }

    document.getElementById('sort-voucherName').addEventListener('click', () => sortVouchers('voucherName'));
    document.getElementById('sort-clientName').addEventListener('click', () => sortVouchers('client.clientName'));
    document.getElementById('sort-noOfVouchers').addEventListener('click', () => sortVouchers('noOfVouchers'));
    document.getElementById('sort-vouchersClaimed').addEventListener('click', () => sortVouchers('claimed'));
    document.getElementById('sort-packageName').addEventListener('click', () => sortVouchers('packageName'));
    document.getElementById('sort-voucherExpired').addEventListener('click', () => sortVouchers('validDate'));
    document.getElementById('sort-voucherIssued').addEventListener('click', () => sortVouchers('issueDate'));

    // Fetch packages and display them




    // Global variables
    let partners = [];
    let currentSortColumn = '';
    let currentSortDirection = true; // true for ascending, false for descending

    // Function to fetch partners and display them


    // Function to fetch partners
    function fetchPartners() {

        fetch("/api/partners/getAll")
            .then(response => response.json())
            .then(data => {
                partners = data;
                displayPartners(partners);
                console.log(partners)

            })
            .catch(error => console.error('Error fetching partners:', error));
    }

    // Function to display partners in the table
    function displayPartners(partners) {
        const tableBody = document.getElementById('partnerTableBody');
        tableBody.innerHTML = ''; // Clear existing rows

        if (partners.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6">No partners found.</td></tr>';
        } else {
            partners.forEach(partner => {
                const row = `
                <tr>
                    <td>${partner.partnerType}</td>
                    <td>${partner.partnerName}</td>
                    <td>${partner.conformationType}</td>
                    <td>${partner.sequence}</td>
                    <td>${partner.packageDetails.packageName}</td>
                    <td>${partner.discount}</td>
                    <td>${partner.createdBy}</td>
                </tr>
            `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }
    }

    // Search functionality
    document.querySelector('#partnerSearch').addEventListener('input', function() {

        const searchTerm = this.value.toLowerCase();
        const filteredPartners = partners.filter(partner => {
            return (
                partner.partnerType.toLowerCase().includes(searchTerm) ||
                partner.partnerName.toLowerCase().includes(searchTerm) ||
                partner.conformationType.toLowerCase().includes(searchTerm) ||
                partner.packageDetails.packageName.toLowerCase().includes(searchTerm) ||
                partner.createdBy.toLowerCase().includes(searchTerm)
            );
        });
        displayPartners(filteredPartners);
    });

    // Function to sort the table
    function sortTable(column) {
        if (currentSortColumn === column) {
            currentSortDirection = !currentSortDirection;
        } else {
            currentSortColumn = column;
            currentSortDirection = true;
        }

        partners.sort((a, b) => {
            let valA = a[column];
            let valB = b[column];

            if (typeof valA === 'string') {
                valA = valA.toUpperCase();
                valB = valB.toUpperCase();
            }

            if (valA < valB) return currentSortDirection ? -1 : 1;
            if (valA > valB) return currentSortDirection ? 1 : -1;
            return 0;
        });

        displayPartners(partners);
    }

    // Add event listeners to the table headers
    document.getElementById('sort-partnerType').addEventListener('click', () => sortTable('partnerType'));
    document.getElementById('sort-partnerName').addEventListener('click', () => sortTable('partnerName'));
    document.getElementById('sort-confirmationMode').addEventListener('click', () => sortTable('conformationType'));
    document.getElementById('sort-confirmationFormat').addEventListener('click', () => sortTable('sequence'));
    document.getElementById('sort-packageName').addEventListener('click', () => sortTable('packageDetails.packageName'));
    document.getElementById('sort-createdBy').addEventListener('click', () => sortTable('createdBy'));

    // Fetch and display partners initially
    fetchPartners();


    // footfall script|
    document.addEventListener('DOMContentLoaded', () => {
        fetch('/api/ticket/count')
            .then(response => response.json())

            .then(data => {
                document.getElementById('totalTickets').textContent = data.totalTickets;
                document.getElementById('voucherTickets').textContent = data.voucherTickets;
                document.getElementById('partnerTickets').textContent = data.partnerTickets;
                document.getElementById('airlineTickets').textContent = data.airlineTickets;
            })
            .catch(error => console.error('Error fetching ticket data:', error));
    });


    $(document).ready(function () {
        // Check if there's a saved active tab in local storage
        var activeTab = localStorage.getItem('activeTab');
        if (activeTab) {
            var someTabTriggerEl = document.querySelector('button[data-bs-target="' + activeTab + '"]');
            var tab = new bootstrap.Tab(someTabTriggerEl);
            tab.show();
        }

        // Save the active tab to local storage when it's clicked
        $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
            var activeTab = $(e.target).attr('data-bs-target');
            localStorage.setItem('activeTab', activeTab);
        });
    });
</script>


</body>

</html>

